<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mezzanine-Zinskalkulator</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            color: #333;
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        .calculator {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="number"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .checkbox-group {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        .checkbox-group label {
            margin-bottom: 0;
            margin-left: 10px;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
        }
        button:hover {
            background-color: #2980b9;
        }
        .btn-danger {
            background-color: #e74c3c;
        }
        .btn-danger:hover {
            background-color: #c0392b;
        }
        .btn-success {
            background-color: #2ecc71;
        }
        .btn-success:hover {
            background-color: #27ae60;
        }
        .results {
            margin-top: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        th, td {
            padding: 10px;
            border: 1px solid #ddd;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        .error {
            color: #e74c3c;
            padding: 10px;
            background-color: #fadbd8;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        .tranche-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .controls {
            display: flex;
            gap: 10px;
            margin: 20px 0;
        }
        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <h1>Zinskalkulator für Mezzanine-Finanzierungen</h1>
    
    <div class="grid">
        <div class="calculator">
            <h2>Allgemeine Einstellungen</h2>
            
            <div class="form-group">
                <label for="gesamtFinanzierung">Gesamtfinanzierung (€)</label>
                <input type="number" id="gesamtFinanzierung" value="1000000">
            </div>
            
            <div class="form-group">
                <label for="gesamtLaufzeit">Gesamtlaufzeit (Monate)</label>
                <input type="number" id="gesamtLaufzeit" value="24" min="1">
            </div>
            
            <div class="form-group">
                <label for="allInMezzanineZins">All-in Mezzanine Zins (%)</label>
                <input type="number" id="allInMezzanineZins" value="15.0" step="0.1">
            </div>
            
            <div class="form-group">
                <label for="crowdZins">Crowd Zins (%)</label>
                <input type="number" id="crowdZins" value="7.0" step="0.1">
            </div>
            
            <div class="form-group">
                <label for="vermittlungsGebuehr">Vermittlungsgebühr (%)</label>
                <input type="number" id="vermittlungsGebuehr" value="5.5" step="0.1">
            </div>
            
            <div class="form-group">
                <label for="strukturierungsGebuehr">Strukturierungsgebühr (€)</label>
                <input type="number" id="strukturierungsGebuehr" value="95000">
            </div>
            
            <div class="checkbox-group">
                <input type="checkbox" id="vermittlungEndfaellig">
                <label for="vermittlungEndfaellig">Vermittlung endfällig</label>
            </div>
            
            <div class="checkbox-group">
                <input type="checkbox" id="strukturierungEndfaellig">
                <label for="strukturierungEndfaellig">Strukturierung endfällig</label>
            </div>
        </div>
        
        <div id="tranchenContainer" class="tranche-container">
            <div class="calculator tranche" data-index="0">
                <h2>Tranche 1</h2>
                
                <div class="form-group">
                    <label for="laufzeit0">Laufzeit (Monate)</label>
                    <input type="number" id="laufzeit0" class="laufzeit" value="24" min="1">
                </div>
                
                <div class="form-group">
                    <label for="trancheFinanzierung0">Finanzierungssumme (€)</label>
                    <input type="number" id="trancheFinanzierung0" class="trancheFinanzierung" value="1000000">
                </div>
                
                <div class="form-group">
                    <label for="trancheAllInMezzanineZins0">All-in Mezzanine Zins (%)</label>
                    <input type="number" id="trancheAllInMezzanineZins0" class="trancheAllInMezzanineZins" value="15.0" step="0.1">
                </div>
                
                <div class="form-group">
                    <label for="trancheCrowdZins0">Crowd Zins (%)</label>
                    <input type="number" id="trancheCrowdZins0" class="trancheCrowdZins" value="7.0" step="0.1">
                </div>
            </div>
        </div>
    </div>
    
    <div class="controls">
        <button id="addTrancheBtn" class="btn-success" onclick="addTranche()">Weitere Tranche hinzufügen</button>
        <button onclick="calculateResults()">Ergebnisse berechnen</button>
    </div>
    
    <div id="errorMessage" class="error" style="display: none;"></div>
    
    <div id="results" style="display: none;">
        <div id="trancheResults"></div>
        
        <div id="gesamtResults" class="results" style="display: none;">
            <h2>Gesamtergebnis über alle Tranchen</h2>
            <table>
                <thead>
                    <tr>
                        <th>Komponente</th>
                        <th>Wert</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Gesamtfinanzierung</td>
                        <td id="gesamtFinanzierungSumme"></td>
                    </tr>
                    <tr>
                        <td>Gesamtzinsen (Netto)</td>
                        <td id="gesamtZinsenNetto"></td>
                    </tr>
                    <tr>
                        <td>Gesamtzinsen (Brutto)</td>
                        <td id="gesamtZinsenBrutto"></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

<script>
        // Nach Document Ready
        document.addEventListener('DOMContentLoaded', function() {
            // Markiere bereits vorhandene Tranchenfelder
            setupTranchenInputs();
            // Synchronisiere Tranche 1 mit Gesamtfinanzierung
            updateTrancheOne();
        });

        // Event-Listener für Gesamtfinanzierung
        document.getElementById('gesamtFinanzierung').addEventListener('change', updateTrancheOne);
        document.getElementById('allInMezzanineZins').addEventListener('change', updateTrancheOne);
        document.getElementById('crowdZins').addEventListener('change', updateTrancheOne);
        document.getElementById('gesamtLaufzeit').addEventListener('change', updateTrancheOne);

        // Tranche 1 mit Gesamtfinanzierung synchronisieren
        function updateTrancheOne() {
            const gesamtFinanzierung = parseFloat(document.getElementById('gesamtFinanzierung').value) || 1000000;
            const allInMezzanineZins = parseFloat(document.getElementById('allInMezzanineZins').value) || 15.0;
            const crowdZins = parseFloat(document.getElementById('crowdZins').value) || 7.0;
            const gesamtLaufzeit = parseInt(document.getElementById('gesamtLaufzeit').value) || 24;
            
            // Erste Tranche aktualisieren
            document.getElementById('trancheFinanzierung0').value = gesamtFinanzierung;
            document.getElementById('trancheAllInMezzanineZins0').value = allInMezzanineZins;
            document.getElementById('trancheCrowdZins0').value = crowdZins;
            document.getElementById('laufzeit0').value = gesamtLaufzeit;
        }

        // Markiere Tranchenfelder als "modifiziert", wenn sie geändert werden
        function setupTranchenInputs() {
            // Initiale Tranche einrichten
            markTrancheInputs(0);
        }

        function markTrancheInputs(index) {
            const allInInput = document.getElementById(`trancheAllInMezzanineZins${index}`);
            const crowdInput = document.getElementById(`trancheCrowdZins${index}`);
            const laufzeitInput = document.getElementById(`laufzeit${index}`);
            const finanzierungInput = document.getElementById(`trancheFinanzierung${index}`);
            
            if (allInInput) {
                allInInput.addEventListener('input', function() {
                    this.dataset.modified = 'true';
                });
            }
            
            if (crowdInput) {
                crowdInput.addEventListener('input', function() {
                    this.dataset.modified = 'true';
                });
            }
            
            if (laufzeitInput) {
                laufzeitInput.addEventListener('input', function() {
                    this.dataset.modified = 'true';
                });
            }
            
            if (finanzierungInput) {
                finanzierungInput.addEventListener('input', function() {
                    this.dataset.modified = 'true';
                });
            }
        }
        
        // Tranche hinzufügen
        function addTranche() {
            const tranchenContainer = document.getElementById('tranchenContainer');
            const tranchenCount = tranchenContainer.querySelectorAll('.tranche').length;
            
            if (tranchenCount >= 3) {
                alert('Maximal 3 Tranchen möglich');
                return;
            }
            
            const trancheIndex = tranchenCount;
            const allInMezzanineZins = parseFloat(document.getElementById('allInMezzanineZins').value) || 15.0;
            const crowdZins = parseFloat(document.getElementById('crowdZins').value) || 7.0;
            const gesamtLaufzeit = parseInt(document.getElementById('gesamtLaufzeit').value) || 24;
            
            const neueTrancheHTML = `
                <div class="calculator tranche" data-index="${trancheIndex}">
                    <div class="tranche-header">
                        <h2>Tranche ${trancheIndex + 1}</h2>
                        <button class="btn-danger" onclick="removeTranche(${trancheIndex})">Entfernen</button>
                    </div>
                    
                    <div class="form-group">
                        <label for="laufzeit${trancheIndex}">Laufzeit (Monate)</label>
                        <input type="number" id="laufzeit${trancheIndex}" class="laufzeit" value="${gesamtLaufzeit}" min="1">
                    </div>
                    
                    <div class="form-group">
                        <label for="trancheFinanzierung${trancheIndex}">Finanzierungssumme (€)</label>
                        <input type="number" id="trancheFinanzierung${trancheIndex}" class="trancheFinanzierung" value="1000000">
                    </div>
                    
                    <div class="form-group">
                        <label for="trancheAllInMezzanineZins${trancheIndex}">All-in Mezzanine Zins (%)</label>
                        <input type="number" id="trancheAllInMezzanineZins${trancheIndex}" class="trancheAllInMezzanineZins" value="${allInMezzanineZins}" step="0.1">
                    </div>
                    
                    <div class="form-group">
                        <label for="trancheCrowdZins${trancheIndex}">Crowd Zins (%)</label>
                        <input type="number" id="trancheCrowdZins${trancheIndex}" class="trancheCrowdZins" value="${crowdZins}" step="0.1">
                    </div>
                </div>
            `;
            
            // HTML an Container anhängen
            tranchenContainer.insertAdjacentHTML('beforeend', neueTrancheHTML);
            
            // Neue Trancheninputs markieren
            markTrancheInputs(trancheIndex);
            
            // Button deaktivieren wenn maximal erreicht
            if (tranchenCount + 1 >= 3) {
                document.getElementById('addTrancheBtn').disabled = true;
            }
        }
        
        // Tranche entfernen
        function removeTranche(index) {
            const tranchen = document.querySelectorAll('.tranche');
            if (tranchen.length <= 1) {
                alert('Mindestens eine Tranche muss vorhanden sein');
                return;
            }
            
            // Zu entfernende Tranche finden
            const trancheToRemove = document.querySelector(`.tranche[data-index="${index}"]`);
            if (trancheToRemove) {
                trancheToRemove.remove();
                
                // Tranchen neu nummerieren
                const remainingTranchen = document.querySelectorAll('.tranche');
                remainingTranchen.forEach((tranche, newIndex) => {
                    const trancheTitle = tranche.querySelector('h2');
                    if (trancheTitle) {
                        trancheTitle.textContent = `Tranche ${newIndex + 1}`;
                    }
                });
                
                // "Hinzufügen"-Button wieder aktivieren
                document.getElementById('addTrancheBtn').disabled = false;
            }
        }
        
        function formatCurrency(value) {
            return new Intl.NumberFormat('de-DE', {
                style: 'currency',
                currency: 'EUR'
            }).format(value);
        }
        
        function formatPercent(value) {
            return new Intl.NumberFormat('de-DE', {
                style: 'percent',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(value / 100);
        }
        
        function formatQuartal(monat) {
            if (monat === 0) return "Initial";
            const jahr = Math.floor(monat / 12) + 1;
            const quartal = Math.ceil((monat % 12) / 3);
            return `Jahr ${jahr}, Q${quartal}`;
        }

function calculateResults() {
            const allInMezzanineZinsGesamt = parseFloat(document.getElementById('allInMezzanineZins').value) || 15.0;
            const crowdZinsGesamt = parseFloat(document.getElementById('crowdZins').value) || 7.0;
            const vermittlungsGebuehr = parseFloat(document.getElementById('vermittlungsGebuehr').value) || 5.5;
            const strukturierungsGebuehr = parseFloat(document.getElementById('strukturierungsGebuehr').value) || 95000;
            const vermittlungEndfaellig = document.getElementById('vermittlungEndfaellig').checked;
            const strukturierungEndfaellig = document.getElementById('strukturierungEndfaellig').checked;
            
            // Alle Tranchen ermitteln
            const tranchenElemente = document.querySelectorAll('.tranche');
            const tranchenErgebnisse = [];
            let errorOccurred = false;
            
            // Fehlertext zurücksetzen
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('errorMessage').textContent = '';
            
            // Ergebnisse zurücksetzen
            document.getElementById('trancheResults').innerHTML = '';
            
            // Jede Tranche berechnen
            tranchenElemente.forEach((trancheElement, index) => {
                const laufzeitMonate = parseInt(document.getElementById(`laufzeit${index}`).value) || 24;
                const laufzeitJahre = laufzeitMonate / 12;
                const gesamtFinanzierung = parseFloat(document.getElementById(`trancheFinanzierung${index}`).value) || 1000000;
                
                // Übernehme Zinssätze aus der Gesamtfinanzierung, wenn Tranche unverändert
                let trancheAllInInput = document.getElementById(`trancheAllInMezzanineZins${index}`);
                let trancheCrowdInput = document.getElementById(`trancheCrowdZins${index}`);
                
                // Wenn das Element nicht manuell geändert wurde, übernehme den Wert aus der Gesamtfinanzierung
                if (!trancheAllInInput.dataset.modified) {
                    trancheAllInInput.value = allInMezzanineZinsGesamt;
                }
                
                if (!trancheCrowdInput.dataset.modified) {
                    trancheCrowdInput.value = crowdZinsGesamt;
                }
                
                const allInMezzanineZins = parseFloat(trancheAllInInput.value) || 15.0;
                const crowdZins = parseFloat(trancheCrowdInput.value) || 7.0;
                
                // Gebühren für diese Tranche berechnen
                const vermittlungsGebuehrBetrag = (vermittlungsGebuehr / 100) * gesamtFinanzierung;
                const strukturierungsGebuehrBetrag = strukturierungsGebuehr;
                
                // Zinsen pro Jahr berechnen
                const crowdZinsenJahr = (crowdZins / 100) * gesamtFinanzierung;
                const allInMezzanineZinsenJahr = (allInMezzanineZins / 100) * gesamtFinanzierung;
                
                // Servicegebühr berechnen (verbleibender Betrag)
                const einmaligeGebuehrenProJahr = (vermittlungsGebuehrBetrag + strukturierungsGebuehrBetrag) / laufzeitJahre;
                const serviceGebuehrJahr = allInMezzanineZinsenJahr - crowdZinsenJahr - einmaligeGebuehrenProJahr;
                
                // Prüfen, ob Servicegebühr positiv ist
                if (serviceGebuehrJahr < 0) {
                    document.getElementById('errorMessage').style.display = 'block';
                    document.getElementById('errorMessage').textContent += `Achtung: Die Servicegebühr für Tranche ${index + 1} ist negativ. Bitte passen Sie die Gebühren oder den All-in-Mezzanine-Zins an. `;
                    errorOccurred = true;
                    return;
                }
                
                // Zahlplan berechnen
                const zahlplan = [];
                
                // Einmalige Gebühren zu Beginn, wenn nicht endfällig
                if (!vermittlungEndfaellig) {
                    zahlplan.push({
                        zeitpunkt: 0,
                        vermittlungsGebuehr: vermittlungsGebuehrBetrag,
                        vermittlungsGebuehrMwSt: vermittlungsGebuehrBetrag * 0.19,
                        strukturierungsGebuehr: !strukturierungEndfaellig ? strukturierungsGebuehrBetrag : 0,
                        strukturierungsGebuehrMwSt: !strukturierungEndfaellig ? strukturierungsGebuehrBetrag * 0.19 : 0,
                        crowdZins: 0,
                        serviceGebuehr: 0,
                        serviceGebuehrMwSt: 0
                    });
                }
                
                // Quartalsweise Zahlungen
                for (let monat = 3; monat <= laufzeitMonate; monat += 3) {
                    zahlplan.push({
                        zeitpunkt: monat,
                        vermittlungsGebuehr: 0,
                        vermittlungsGebuehrMwSt: 0,
                        strukturierungsGebuehr: 0,
                        strukturierungsGebuehrMwSt: 0,
                        crowdZins: crowdZinsenJahr / 4,
                        serviceGebuehr: serviceGebuehrJahr / 4,
                        serviceGebuehrMwSt: (serviceGebuehrJahr / 4) * 0.19
                    });
                }
                
                // Endfällige Gebühren
                if (vermittlungEndfaellig || strukturierungEndfaellig) {
                    const letzterEintrag = {
                        zeitpunkt: laufzeitMonate,
                        vermittlungsGebuehr: vermittlungEndfaellig ? vermittlungsGebuehrBetrag : 0,
                        vermittlungsGebuehrMwSt: vermittlungEndfaellig ? vermittlungsGebuehrBetrag * 0.19 : 0,
                        strukturierungsGebuehr: strukturierungEndfaellig ? strukturierungsGebuehrBetrag : 0,
                        strukturierungsGebuehrMwSt: strukturierungEndfaellig ? strukturierungsGebuehrBetrag * 0.19 : 0,
                        crowdZins: 0,
                        serviceGebuehr: 0,
                        serviceGebuehrMwSt: 0
                    };
                    
                    // Prüfen, ob bereits ein Eintrag für diesen Zeitpunkt existiert
                    const existingEntryIndex = zahlplan.findIndex(entry => entry.zeitpunkt === laufzeitMonate);
                    if (existingEntryIndex !== -1) {
                        // Bestehenden Eintrag aktualisieren
                        const entry = zahlplan[existingEntryIndex];
                        entry.vermittlungsGebuehr += letzterEintrag.vermittlungsGebuehr;
                        entry.vermittlungsGebuehrMwSt += letzterEintrag.vermittlungsGebuehrMwSt;
                        entry.strukturierungsGebuehr += letzterEintrag.strukturierungsGebuehr;
                        entry.strukturierungsGebuehrMwSt += letzterEintrag.strukturierungsGebuehrMwSt;
                    } else {
                        // Neuen Eintrag hinzufügen
                        zahlplan.push(letzterEintrag);
                    }
                }
                
                // Sortieren nach Zeitpunkt
                zahlplan.sort((a, b) => a.zeitpunkt - b.zeitpunkt);
                
                // Gesamtbeträge berechnen
                const gesamtVermittlungsGebuehr = zahlplan.reduce((sum, z) => sum + z.vermittlungsGebuehr, 0);
                const gesamtStrukturierungsGebuehr = zahlplan.reduce((sum, z) => sum + z.strukturierungsGebuehr, 0);
                const gesamtCrowdZinsen = zahlplan.reduce((sum, z) => sum + z.crowdZins, 0);
                const gesamtServiceGebuehr = zahlplan.reduce((sum, z) => sum + z.serviceGebuehr, 0);
                
                // MwSt-Beträge
                const gesamtVermittlungsGebuehrMwSt = zahlplan.reduce((sum, z) => sum + z.vermittlungsGebuehrMwSt, 0);
                const gesamtStrukturierungsGebuehrMwSt = zahlplan.reduce((sum, z) => sum + z.strukturierungsGebuehrMwSt, 0);
                const gesamtServiceGebuehrMwSt = zahlplan.reduce((sum, z) => sum + z.serviceGebuehrMwSt, 0);
                
                // Gesamt Netto & Brutto
                const gesamtNetto = gesamtVermittlungsGebuehr + gesamtStrukturierungsGebuehr + gesamtCrowdZinsen + gesamtServiceGebuehr;
                const gesamtBrutto = gesamtNetto + gesamtVermittlungsGebuehrMwSt + gesamtStrukturierungsGebuehrMwSt + gesamtServiceGebuehrMwSt;
                
                // Pro Jahr Beträge
                const perAnnumNetto = gesamtNetto / laufzeitJahre;
                const perAnnumBrutto = gesamtBrutto / laufzeitJahre;
                
                // Ergebnis für diese Tranche speichern
                tranchenErgebnisse.push({
                    index,
                    laufzeitMonate,
                    laufzeitJahre,
                    gesamtFinanzierung,
                    allInMezzanineZins,
                    crowdZins,
                    vermittlungsGebuehrBetrag,
                    strukturierungsGebuehrBetrag,
                    serviceGebuehrJahr,
                    zahlplan,
                    perAnnumNetto,
                    perAnnumBrutto,
                    gesamtNetto,
                    gesamtBrutto
                });
                
                // HTML für diese Tranche erstellen
                const trancheHTML = `
                    <div class="results">
                        <h2>Tranche ${index + 1} - Laufzeit: ${laufzeitMonate} Monate (${laufzeitJahre.toFixed(1)} Jahre)</h2>
                        
                        <table>
                            <thead>
                                <tr>
                                    <th>Komponente</th>
                                    <th>% p.a.</th>
                                    <th>Per Annum</th>
                                    <th>Gesamt (Netto)</th>
                                    <th>Gesamt (Brutto)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="font-medium">Gesamtfinanzierung</td>
                                    <td>-</td>
                                    <td>-</td>
                                    <td>${formatCurrency(gesamtFinanzierung)}</td>
                                    <td>-</td>
                                </tr>
                                <tr>
                                    <td>All-in Mezzanine Zins</td>
                                    <td>${allInMezzanineZins.toFixed(2)} %</td>
                                    <td>${formatCurrency(allInMezzanineZinsenJahr)}</td>
                                    <td>${formatCurrency(allInMezzanineZinsenJahr * laufzeitJahre)}</td>
                                    <td>-</td>
                                </tr>
                                <tr>
                                    <td>Crowd Zins</td>
                                    <td>${crowdZins.toFixed(2)} %</td>
                                    <td>${formatCurrency(crowdZinsenJahr)}</td>
                                    <td>${formatCurrency(gesamtCrowdZinsen)}</td>
                                    <td>${formatCurrency(gesamtCrowdZinsen)}</td>
                                </tr>
                                <tr>
                                    <td>Vermittlungsgebühr</td>
                                    <td>${vermittlungsGebuehr.toFixed(2)} %</td>
                                    <td>${formatCurrency(vermittlungsGebuehrBetrag / laufzeitJahre)}</td>
                                    <td>${formatCurrency(gesamtVermittlungsGebuehr)}</td>
                                    <td>${formatCurrency(gesamtVermittlungsGebuehr + gesamtVermittlungsGebuehrMwSt)}</td>
                                </tr>
                                <tr>
                                    <td>Strukturierungsgebühr</td>
                                    <td>${(strukturierungsGebuehrBetrag / gesamtFinanzierung * 100).toFixed(2)} %</td>
                                    <td>${formatCurrency(strukturierungsGebuehrBetrag / laufzeitJahre)}</td>
                                    <td>${formatCurrency(gesamtStrukturierungsGebuehr)}</td>
                                    <td>${formatCurrency(gesamtStrukturierungsGebuehr + gesamtStrukturierungsGebuehrMwSt)}</td>
                                </tr>
                                <tr>
                                    <td>Servicegebühr</td>
                                    <td>${(serviceGebuehrJahr / gesamtFinanzierung * 100).toFixed(2)} %</td>
                                    <td>${formatCurrency(serviceGebuehrJahr)}</td>
                                    <td>${formatCurrency(gesamtServiceGebuehr)}</td>
                                    <td>${formatCurrency(gesamtServiceGebuehr + gesamtServiceGebuehrMwSt)}</td>
                                </tr>
                                <tr class="font-bold bg-gray-100">
                                    <td>Summe</td>
                                    <td>${(perAnnumNetto / gesamtFinanzierung * 100).toFixed(2)} %</td>
                                    <td>${formatCurrency(perAnnumNetto)}</td>
                                    <td>${formatCurrency(gesamtNetto)}</td>
                                    <td>${formatCurrency(gesamtBrutto)}</td>
                                </tr>
                            </tbody>
                        </table>
                        
                        <h3 class="mt-4 mb-2">Zahlplan</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Zeitpunkt</th>
                                    <th>Vermittlung</th>
                                    <th>Strukturierung</th>
                                    <th>Crowd Zinsen</th>
                                    <th>Servicegebühr</th>
                                    <th>Gesamt Netto</th>
                                    <th>MwSt</th>
                                    <th>Gesamt Brutto</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${zahlplan.map(zahlung => {
                                    const gesamtNetto = zahlung.vermittlungsGebuehr + zahlung.strukturierungsGebuehr + zahlung.crowdZins + zahlung.serviceGebuehr;
                                    const gesamtMwSt = zahlung.vermittlungsGebuehrMwSt + zahlung.strukturierungsGebuehrMwSt + zahlung.serviceGebuehrMwSt;
                                    const gesamtBrutto = gesamtNetto + gesamtMwSt;
                                    
                                    return `
                                        <tr>
                                            <td>${formatQuartal(zahlung.zeitpunkt)}</td>
                                            <td>${formatCurrency(zahlung.vermittlungsGebuehr)}</td>
                                            <td>${formatCurrency(zahlung.strukturierungsGebuehr)}</td>
                                            <td>${formatCurrency(zahlung.crowdZins)}</td>
                                            <td>${formatCurrency(zahlung.serviceGebuehr)}</td>
                                            <td>${formatCurrency(gesamtNetto)}</td>
                                            <td>${formatCurrency(gesamtMwSt)}</td>
                                            <td>${formatCurrency(gesamtBrutto)}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                
                // HTML für diese Tranche zur Gesamtansicht hinzufügen
                document.getElementById('trancheResults').insertAdjacentHTML('beforeend', trancheHTML);
            });
            
            // Wenn kein Fehler aufgetreten ist
            if (!errorOccurred) {
                // Ergebnisse anzeigen
                document.getElementById('results').style.display = 'block';
                
                // Gesamtergebnis über alle Tranchen berechnen, wenn mehr als eine Tranche
                if (tranchenErgebnisse.length > 1) {
                    const gesamtFinanzierung = tranchenErgebnisse.reduce((sum, tranche) => sum + tranche.gesamtFinanzierung, 0);
                    const gesamtZinsenNetto = tranchenErgebnisse.reduce((sum, tranche) => sum + tranche.gesamtNetto, 0);
                    const gesamtZinsenBrutto = tranchenErgebnisse.reduce((sum, tranche) => sum + tranche.gesamtBrutto, 0);
                    
                    // Gesamtergebnis anzeigen
                    document.getElementById('gesamtFinanzierungSumme').textContent = formatCurrency(gesamtFinanzierung);
                    document.getElementById('gesamtZinsenNetto').textContent = formatCurrency(gesamtZinsenNetto);
                    document.getElementById('gesamtZinsenBrutto').textContent = formatCurrency(gesamtZinsenBrutto);
                    
                    document.getElementById('gesamtResults').style.display = 'block';
                } else {
                    document.getElementById('gesamtResults').style.display = 'none';
                }
            }
        }
    </script>
</body>
</html>
