function calculateResults() {
    // Globale Werte (werden ggf. nicht mehr für die direkte Berechnung benötigt,
    // aber können für Defaults oder Vergleiche nützlich sein)
    // const allInMezzanineZinsGesamt = parseFloat(document.getElementById('allInMezzanineZins').value) || 15.0;
    // const crowdZinsGesamt = parseFloat(document.getElementById('crowdZins').value) || 7.0;
    // const vermittlungsGebuehrGlobal = parseFloat(document.getElementById('vermittlungsGebuehr').value) || 5.5; // Umbenannt zur Klarheit
    // const strukturierungsGebuehrGlobal = parseFloat(document.getElementById('strukturierungsGebuehr').value) || 95000; // Umbenannt zur Klarheit

    // Diese Checkboxen sind global und gelten für alle Tranchen
    const vermittlungEndfaellig = document.getElementById('vermittlungEndfaellig').checked;
    const strukturierungEndfaellig = document.getElementById('strukturierungEndfaellig').checked;

    // Alle Tranchen ermitteln
    const tranchenElemente = document.querySelectorAll('.tranche');
    const tranchenErgebnisse = [];
    let errorOccurred = false;

    // Fehlertext zurücksetzen
    document.getElementById('errorMessage').style.display = 'none';
    document.getElementById('errorMessage').textContent = '';

    // Ergebnisse zurücksetzen
    document.getElementById('trancheResults').innerHTML = '';

    // Jede Tranche berechnen
    tranchenElemente.forEach((trancheElement, index) => {
        const laufzeitMonate = parseInt(document.getElementById(`laufzeit${index}`).value) || 24;
        const laufzeitJahre = laufzeitMonate / 12;
        const gesamtFinanzierung = parseFloat(document.getElementById(`trancheFinanzierung${index}`).value) || 1000000;

        // --- KORREKTUR START ---
        // Lese die Werte *direkt* aus den Feldern der aktuellen Tranche
        let trancheAllInInput = document.getElementById(`trancheAllInMezzanineZins${index}`);
        let trancheCrowdInput = document.getElementById(`trancheCrowdZins${index}`);
        let trancheVermittlungsGebuehrInput = document.getElementById(`trancheVermittlungsGebuehr${index}`);
        let trancheStrukturierungsGebuehrInput = document.getElementById(`trancheStrukturierungsGebuehr${index}`);

        const allInMezzanineZins = parseFloat(trancheAllInInput.value) || 15.0;
        const crowdZins = parseFloat(trancheCrowdInput.value) || 7.0;
        const trancheVermittlungsGebuehrProzent = parseFloat(trancheVermittlungsGebuehrInput.value) || 5.5; // Verwende den Wert aus dem Tranchen-Input
        const trancheStrukturierungsGebuehrBetrag = parseFloat(trancheStrukturierungsGebuehrInput.value) || 95000; // Verwende den Wert aus dem Tranchen-Input

        // Gebühren für DIESE Tranche berechnen, basierend auf den Tranchen-Werten
        const vermittlungsGebuehrBetrag = (trancheVermittlungsGebuehrProzent / 100) * gesamtFinanzierung;
        const strukturierungsGebuehrBetrag = trancheStrukturierungsGebuehrBetrag; // Ist bereits ein absoluter Betrag
        // --- KORREKTUR ENDE ---


        // Zinsen pro Jahr berechnen (wie gehabt, aber mit Tranchen-Zinssätzen)
        const crowdZinsenJahr = (crowdZins / 100) * gesamtFinanzierung;
        const allInMezzanineZinsenJahr = (allInMezzanineZins / 100) * gesamtFinanzierung;

        // Servicegebühr berechnen (verbleibender Betrag)
        // ACHTUNG: Hier müssen die *berechneten* Beträge der Tranchen-Gebühren verwendet werden
        const einmaligeGebuehrenProJahr = (vermittlungsGebuehrBetrag + strukturierungsGebuehrBetrag) / laufzeitJahre;
        const serviceGebuehrJahr = allInMezzanineZinsenJahr - crowdZinsenJahr - einmaligeGebuehrenProJahr;

        // Prüfen, ob Servicegebühr positiv ist
        if (serviceGebuehrJahr < 0) {
            document.getElementById('errorMessage').style.display = 'block';
            document.getElementById('errorMessage').textContent += `Achtung: Die Servicegebühr für Tranche ${index + 1} ist negativ (${formatCurrency(serviceGebuehrJahr)} p.a.). Bitte passen Sie die Gebühren oder den All-in-Mezzanine-Zins an. `;
            errorOccurred = true;
            // Optional: Berechnung für diese Tranche abbrechen oder fortfahren
             // return; // <-- Wenn die Berechnung komplett stoppen soll
        }

        // Zahlplan berechnen
        const zahlplan = [];

        // Einmalige Gebühren zu Beginn, wenn nicht endfällig
        // Verwende die oben berechneten Beträge (vermittlungsGebuehrBetrag, strukturierungsGebuehrBetrag)
        if (!vermittlungEndfaellig || !strukturierungEndfaellig) {
             zahlplan.push({
                zeitpunkt: 0,
                vermittlungsGebuehr: !vermittlungEndfaellig ? vermittlungsGebuehrBetrag : 0,
                vermittlungsGebuehrMwSt: !vermittlungEndfaellig ? vermittlungsGebuehrBetrag * 0.19 : 0,
                strukturierungsGebuehr: !strukturierungEndfaellig ? strukturierungsGebuehrBetrag : 0,
                strukturierungsGebuehrMwSt: !strukturierungEndfaellig ? strukturierungsGebuehrBetrag * 0.19 : 0,
                crowdZins: 0,
                serviceGebuehr: 0,
                serviceGebuehrMwSt: 0
            });
        }


        // Quartalsweise Zahlungen (wie gehabt)
        for (let monat = 3; monat <= laufzeitMonate; monat += 3) {
            zahlplan.push({
                zeitpunkt: monat,
                vermittlungsGebuehr: 0,
                vermittlungsGebuehrMwSt: 0,
                strukturierungsGebuehr: 0,
                strukturierungsGebuehrMwSt: 0,
                crowdZins: crowdZinsenJahr / 4,
                serviceGebuehr: serviceGebuehrJahr < 0 ? 0 : serviceGebuehrJahr / 4, // Keine negative Servicegebühr zahlen
                serviceGebuehrMwSt: serviceGebuehrJahr < 0 ? 0 : (serviceGebuehrJahr / 4) * 0.19
            });
        }

        // Endfällige Gebühren (wie gehabt, aber mit den korrekten Beträgen)
        if (vermittlungEndfaellig || strukturierungEndfaellig) {
            const letzterEintrag = {
                zeitpunkt: laufzeitMonate,
                vermittlungsGebuehr: vermittlungEndfaellig ? vermittlungsGebuehrBetrag : 0,
                vermittlungsGebuehrMwSt: vermittlungEndfaellig ? vermittlungsGebuehrBetrag * 0.19 : 0,
                strukturierungsGebuehr: strukturierungEndfaellig ? strukturierungsGebuehrBetrag : 0,
                strukturierungsGebuehrMwSt: strukturierungEndfaellig ? strukturierungsGebuehrBetrag * 0.19 : 0,
                crowdZins: 0,
                serviceGebuehr: 0,
                serviceGebuehrMwSt: 0
            };

            // Prüfen, ob bereits ein Eintrag für diesen Zeitpunkt existiert
            const existingEntryIndex = zahlplan.findIndex(entry => entry.zeitpunkt === laufzeitMonate);
            if (existingEntryIndex !== -1) {
                // Bestehenden Eintrag aktualisieren
                const entry = zahlplan[existingEntryIndex];
                entry.vermittlungsGebuehr += letzterEintrag.vermittlungsGebuehr;
                entry.vermittlungsGebuehrMwSt += letzterEintrag.vermittlungsGebuehrMwSt;
                entry.strukturierungsGebuehr += letzterEintrag.strukturierungsGebuehr;
                entry.strukturierungsGebuehrMwSt += letzterEintrag.strukturierungsGebuehrMwSt;
            } else {
                // Neuen Eintrag hinzufügen
                 // Nur hinzufügen, wenn Beträge > 0 sind oder wenn es der einzige Endfälligkeitseintrag ist
                if (letzterEintrag.vermittlungsGebuehr > 0 || letzterEintrag.strukturierungsGebuehr > 0 || zahlplan.findIndex(entry => entry.zeitpunkt === laufzeitMonate) === -1) {
                    zahlplan.push(letzterEintrag);
                }
            }
        }


        // Sortieren nach Zeitpunkt (wie gehabt)
        zahlplan.sort((a, b) => a.zeitpunkt - b.zeitpunkt);

        // Gesamtbeträge berechnen (wie gehabt)
        const gesamtVermittlungsGebuehr = zahlplan.reduce((sum, z) => sum + z.vermittlungsGebuehr, 0);
        const gesamtStrukturierungsGebuehr = zahlplan.reduce((sum, z) => sum + z.strukturierungsGebuehr, 0);
        const gesamtCrowdZinsen = zahlplan.reduce((sum, z) => sum + z.crowdZins, 0);
        const gesamtServiceGebuehr = zahlplan.reduce((sum, z) => sum + z.serviceGebuehr, 0);

        // MwSt-Beträge (wie gehabt)
        const gesamtVermittlungsGebuehrMwSt = zahlplan.reduce((sum, z) => sum + z.vermittlungsGebuehrMwSt, 0);
        const gesamtStrukturierungsGebuehrMwSt = zahlplan.reduce((sum, z) => sum + z.strukturierungsGebuehrMwSt, 0);
        const gesamtServiceGebuehrMwSt = zahlplan.reduce((sum, z) => sum + z.serviceGebuehrMwSt, 0);

        // Gesamt Netto & Brutto (wie gehabt)
        const gesamtNetto = gesamtVermittlungsGebuehr + gesamtStrukturierungsGebuehr + gesamtCrowdZinsen + gesamtServiceGebuehr;
        const gesamtBrutto = gesamtNetto + gesamtVermittlungsGebuehrMwSt + gesamtStrukturierungsGebuehrMwSt + gesamtServiceGebuehrMwSt;

        // Pro Jahr Beträge (wie gehabt)
        const perAnnumNetto = gesamtNetto / laufzeitJahre;
        const perAnnumBrutto = gesamtBrutto / laufzeitJahre;

        // Ergebnis für diese Tranche speichern
        tranchenErgebnisse.push({
            index,
            laufzeitMonate,
            laufzeitJahre,
            gesamtFinanzierung,
            allInMezzanineZins,
            crowdZins,
            // Speichere die verwendeten Gebühren für die Anzeige
            trancheVermittlungsGebuehrProzent,
            vermittlungsGebuehrBetrag, // Der absolute Betrag
            strukturierungsGebuehrBetrag,
            serviceGebuehrJahr,
            zahlplan,
            perAnnumNetto,
            perAnnumBrutto,
            gesamtNetto,
            gesamtBrutto
        });

        // HTML für diese Tranche erstellen
        // --- KORREKTUR ANZEIGE ---
        // Stelle sicher, dass die korrekten Prozentsätze angezeigt werden
        const trancheHTML = `
            <div class="results">
                <h2>Tranche ${index + 1} - Laufzeit: ${laufzeitMonate} Monate (${laufzeitJahre.toFixed(1)} Jahre)</h2>

                <table>
                    <thead>
                        <tr>
                            <th>Komponente</th>
                            <th>% p.a. / % Einmal</th>
                            <th>Per Annum</th>
                            <th>Gesamt (Netto)</th>
                            <th>Gesamt (Brutto)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="font-medium">Gesamtfinanzierung</td>
                            <td>-</td>
                            <td>-</td>
                            <td>${formatCurrency(gesamtFinanzierung)}</td>
                            <td>-</td>
                        </tr>
                        <tr>
                            <td>All-in Mezzanine Zins</td>
                            <td>${allInMezzanineZins.toFixed(2)} % p.a.</td>
                            <td>${formatCurrency(allInMezzanineZinsenJahr)}</td>
                            <td>${formatCurrency(allInMezzanineZinsenJahr * laufzeitJahre)}</td>
                            <td>-</td>
                        </tr>
                        <tr>
                            <td>Crowd Zins</td>
                            <td>${crowdZins.toFixed(2)} % p.a.</td>
                            <td>${formatCurrency(crowdZinsenJahr)}</td>
                            <td>${formatCurrency(gesamtCrowdZinsen)}</td>
                            <td>${formatCurrency(gesamtCrowdZinsen)}</td>
                        </tr>
                        <tr>
                            <td>Vermittlungsgebühr</td>
                            <td>${trancheVermittlungsGebuehrProzent.toFixed(2)} %</td> {/* Korrigiert: Zeige % aus Tranche */}
                            <td>${formatCurrency(vermittlungsGebuehrBetrag / laufzeitJahre)}</td>
                            <td>${formatCurrency(gesamtVermittlungsGebuehr)}</td>
                            <td>${formatCurrency(gesamtVermittlungsGebuehr + gesamtVermittlungsGebuehrMwSt)}</td>
                        </tr>
                        <tr>
                            <td>Strukturierungsgebühr</td>
                             {/* Zeige % bezogen auf Tranchenfinanzierung */}
                            <td>${(strukturierungsGebuehrBetrag / gesamtFinanzierung * 100).toFixed(2)} %</td>
                            <td>${formatCurrency(strukturierungsGebuehrBetrag / laufzeitJahre)}</td>
                            <td>${formatCurrency(gesamtStrukturierungsGebuehr)}</td>
                            <td>${formatCurrency(gesamtStrukturierungsGebuehr + gesamtStrukturierungsGebuehrMwSt)}</td>
                        </tr>
                        <tr>
                            <td>Servicegebühr</td>
                             {/* Zeige % p.a. */}
                            <td>${(serviceGebuehrJahr / gesamtFinanzierung * 100).toFixed(2)} % p.a.</td>
                            <td>${formatCurrency(serviceGebuehrJahr)}</td>
                            <td>${formatCurrency(gesamtServiceGebuehr)}</td>
                            <td>${formatCurrency(gesamtServiceGebuehr + gesamtServiceGebuehrMwSt)}</td>
                        </tr>
                        <tr class="font-bold bg-gray-100">
                            <td>Summe</td>
                            <td>${(perAnnumNetto / gesamtFinanzierung * 100).toFixed(2)} % p.a.</td>
                            <td>${formatCurrency(perAnnumNetto)}</td>
                            <td>${formatCurrency(gesamtNetto)}</td>
                            <td>${formatCurrency(gesamtBrutto)}</td>
                        </tr>
                    </tbody>
                </table>

                <h3 class="mt-4 mb-2">Zahlplan</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Zeitpunkt</th>
                            <th>Vermittlung</th>
                            <th>Strukturierung</th>
                            <th>Crowd Zinsen</th>
                            <th>Servicegebühr</th>
                            <th>Gesamt Netto</th>
                            <th>MwSt</th>
                            <th>Gesamt Brutto</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${zahlplan.map(zahlung => {
                            const gesamtNetto = zahlung.vermittlungsGebuehr + zahlung.strukturierungsGebuehr + zahlung.crowdZins + zahlung.serviceGebuehr;
                            const gesamtMwSt = zahlung.vermittlungsGebuehrMwSt + zahlung.strukturierungsGebuehrMwSt + zahlung.serviceGebuehrMwSt;
                            const gesamtBrutto = gesamtNetto + gesamtMwSt;

                            return `
                                <tr>
                                    <td>${formatQuartal(zahlung.zeitpunkt)}</td>
                                    <td>${formatCurrency(zahlung.vermittlungsGebuehr)}</td>
                                    <td>${formatCurrency(zahlung.strukturierungsGebuehr)}</td>
                                    <td>${formatCurrency(zahlung.crowdZins)}</td>
                                    <td>${formatCurrency(zahlung.serviceGebuehr)}</td>
                                    <td>${formatCurrency(gesamtNetto)}</td>
                                    <td>${formatCurrency(gesamtMwSt)}</td>
                                    <td>${formatCurrency(gesamtBrutto)}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            </div>
        `;

        // HTML für diese Tranche zur Gesamtansicht hinzufügen
        document.getElementById('trancheResults').insertAdjacentHTML('beforeend', trancheHTML);
    });

    // Wenn kein Fehler aufgetreten ist (oder trotz Fehler angezeigt werden soll)
    if (!errorOccurred || tranchenErgebnisse.length > 0) { // Zeige Ergebnisse auch wenn Fehler, aber zumindest eine Tranche berechnet wurde
        // Ergebnisse anzeigen
        document.getElementById('results').style.display = 'block';

        // Gesamtergebnis über alle Tranchen berechnen, wenn mehr als eine Tranche
        if (tranchenErgebnisse.length > 1) {
            const gesamtFinanzierung = tranchenErgebnisse.reduce((sum, tranche) => sum + tranche.gesamtFinanzierung, 0);
            const gesamtZinsenNetto = tranchenErgebnisse.reduce((sum, tranche) => sum + tranche.gesamtNetto, 0);
            const gesamtZinsenBrutto = tranchenErgebnisse.reduce((sum, tranche) => sum + tranche.gesamtBrutto, 0);

            // Gesamtergebnis anzeigen
            document.getElementById('gesamtFinanzierungSumme').textContent = formatCurrency(gesamtFinanzierung);
            document.getElementById('gesamtZinsenNetto').textContent = formatCurrency(gesamtZinsenNetto);
            document.getElementById('gesamtZinsenBrutto').textContent = formatCurrency(gesamtZinsenBrutto);

            document.getElementById('gesamtResults').style.display = 'block';
        } else {
            document.getElementById('gesamtResults').style.display = 'none';
        }
    } else {
         // Wenn Fehler aufgetreten sind und keine Ergebnisse berechnet wurden
         document.getElementById('results').style.display = 'none';
         document.getElementById('gesamtResults').style.display = 'none';
    }
}
