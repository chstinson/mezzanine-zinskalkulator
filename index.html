<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mezzanine-Zinskalkulator</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> <!-- Chart.js hinzufügen -->
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            color: #333;
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        .calculator {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="number"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box; /* Added for consistent sizing */
        }
        .checkbox-group {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        .checkbox-group label {
            margin-bottom: 0;
            margin-left: 10px;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
        }
        button:hover {
            background-color: #2980b9;
        }
        .btn-danger {
            background-color: #e74c3c;
        }
        .btn-danger:hover {
            background-color: #c0392b;
        }
        .btn-success {
            background-color: #2ecc71;
        }
        .btn-success:hover {
            background-color: #27ae60;
        }
        .results {
            margin-top: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); /* Added shadow like inputs */
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        th, td {
            padding: 10px;
            border: 1px solid #ddd;
            text-align: left;
            vertical-align: top; /* Better alignment */
        }
        th {
            background-color: #e9ecef; /* Slightly different header color */
            font-weight: bold; /* Explicitly bold */
        }
        td {
             word-break: break-word; /* Prevent long words from breaking layout */
        }
        .error {
            color: #e74c3c; /* Rot für Fehler/Warnungen */
            padding: 10px;
            background-color: #fadbd8;
            border: 1px solid #f5c6cb; /* Added border */
            border-radius: 4px;
            margin-bottom: 15px;
        }
        /* Optional: Eigene Klasse für reine Warnungen, falls gewünscht */
        /* .warning {
            color: #856404;
            background-color: #fff3cd;
            border-color: #ffeeba;
        } */
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        .tranche-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .controls {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap; /* Allow buttons to wrap on small screens */
        }
        .tranche-header { /* Style for header within tranche box */
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .tranche-header h2 {
            margin: 0; /* Remove default margin */
        }
        .font-medium {
             font-weight: 500;
        }
        .font-bold {
            font-weight: bold;
        }
        .bg-gray-100 { /* Simple background utility */
            background-color: #f8f9fa;
        }
        .mt-4 { margin-top: 1rem; } /* Utility classes */
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-4 { margin-bottom: 1rem; }

        /* Styling für Chart-Container */
        .chart-container {
            margin-top: 30px;
            padding: 20px;
            background-color: #ffffff; /* Weißer Hintergrund für Charts */
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }
        .chart-container h3 {
            text-align: center;
            margin-bottom: 15px;
            color: #2c3e50;
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <h1>Zinskalkulator für Mezzanine-Finanzierungen</h1>

    <div class="grid">
        <div class="calculator">
            <h2>Allgemeine Einstellungen</h2>

            <div class="form-group">
                <label for="gesamtFinanzierung">Gesamtfinanzierung (€) <small>(Nur für Initialwerte Tranche 1)</small></label>
                <input type="number" id="gesamtFinanzierung" value="1000000">
            </div>

            <div class="form-group">
                <label for="gesamtLaufzeit">Gesamtlaufzeit (Monate) <small>(Nur für Initialwerte)</small></label>
                <input type="number" id="gesamtLaufzeit" value="24" min="1">
            </div>

            <div class="form-group">
                <label for="allInMezzanineZins">All-in Mezzanine Zins (%) <small>(Nur für Initialwerte)</small></label>
                <input type="number" id="allInMezzanineZins" value="15.0" step="0.1">
            </div>

            <div class="form-group">
                <label for="crowdZins">Crowd Zins (%) <small>(Nur für Initialwerte)</small></label>
                <input type="number" id="crowdZins" value="7.0" step="0.1">
            </div>

            <div class="form-group">
                <label for="vermittlungsGebuehr">Vermittlungsgebühr (%) <small>(Nur für Initialwerte)</small></label>
                <input type="number" id="vermittlungsGebuehr" value="5.5" step="0.1">
            </div>

            <div class="form-group">
                <label for="strukturierungsGebuehr">Strukturierungsgebühr (€) <small>(Nur für Initialwerte)</small></label>
                <input type="number" id="strukturierungsGebuehr" value="95000">
            </div>

            <div class="checkbox-group">
                <input type="checkbox" id="vermittlungEndfaellig">
                <label for="vermittlungEndfaellig">Vermittlungsgebühr endfällig</label>
            </div>

            <div class="checkbox-group">
                <input type="checkbox" id="strukturierungEndfaellig">
                <label for="strukturierungEndfaellig">Strukturierungsgebühr endfällig</label>
            </div>
        </div>

        <div id="tranchenContainer" class="tranche-container">
            <!-- Erste Tranche wird hier eingefügt -->
        </div>
    </div> <!-- Ende .grid -->

    <div class="controls">
        <button id="addTrancheBtn" class="btn-success" onclick="addTranche()">Weitere Tranche hinzufügen</button>
        <button onclick="calculateResults()">Ergebnisse berechnen</button>
    </div>

    <div id="errorMessage" class="error" style="display: none;"></div>

    <div id="results" style="display: none;">
        <div id="trancheResults">
             <!-- Hier werden die Ergebnisse der einzelnen Tranchen eingefügt -->
        </div>

        <!-- Detaillierteres Gesamtergebnis -->
        <div id="gesamtResults" class="results" style="display: none;">
            <h2>Gesamtergebnis über alle Tranchen</h2>
            <table>
                <thead>
                    <tr>
                        <th>Komponente</th>
                        <th>Wert</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Gesamtfinanzierung</td>
                        <td id="gesamtFinanzierungSumme"></td>
                    </tr>
                     <tr>
                        <td>Gewichtete durchschn. Laufzeit</td>
                        <td id="gesamtGewichteteLaufzeit"></td>
                    </tr>
                    <tr>
                        <td class="font-bold">Gesamtkosten (Netto)</td>
                        <td id="gesamtKostenNettoSumme" class="font-bold"></td>
                    </tr>
                    <tr>
                        <td style="padding-left: 25px;">↳ davon Crowd-Zinsen</td>
                        <td id="gesamtCrowdZinsSumme"></td>
                    </tr>
                    <tr>
                        <td style="padding-left: 25px;">↳ davon Vermittlungsgebühr</td>
                        <td id="gesamtVermittlungsGebuehrSumme"></td>
                    </tr>
                     <tr>
                        <td style="padding-left: 25px;">↳ davon Strukturierungsgebühr</td>
                        <td id="gesamtStrukturierungsGebuehrSumme"></td>
                    </tr>
                     <tr>
                        <td style="padding-left: 25px;">↳ davon Servicegebühr</td>
                        <td id="gesamtServiceGebuehrSumme"></td>
                    </tr>
                    <tr>
                        <td class="font-bold">Gesamtkosten (Brutto)</td>
                        <td id="gesamtKostenBruttoSumme" class="font-bold"></td>
                    </tr>
                     <tr>
                        <td>Effektiver Netto-Gesamtkostensatz p.a.</td>
                        <td id="gesamtEffektivZinsNettoPA"></td>
                    </tr>
                </tbody>
            </table>
        </div>

         <!-- Container für die Diagramme -->
         <div id="chartSection" style="display: none;">
            <div class="chart-container">
                <h3>Kostenverteilung über die Laufzeit (Netto)</h3>
                <canvas id="costDistributionChart"></canvas>
            </div>
            <div class="chart-container">
                <h3>Aufteilung der Gesamtkosten (Netto)</h3>
                <canvas id="costBreakdownChart"></canvas>
            </div>
        </div>

    </div>

<script>
        // Globale Variablen für Chart-Instanzen
        window.myDistributionChart = null;
        window.myBreakdownChart = null;

        document.addEventListener('DOMContentLoaded', function() {
            // Event-Listener für globale Felder, um Tranche 1 zu aktualisieren
            document.getElementById('gesamtFinanzierung').addEventListener('input', updateTrancheOneIfNeeded);
            document.getElementById('allInMezzanineZins').addEventListener('input', updateTrancheOneIfNeeded);
            document.getElementById('crowdZins').addEventListener('input', updateTrancheOneIfNeeded);
            document.getElementById('gesamtLaufzeit').addEventListener('input', updateTrancheOneIfNeeded);
            document.getElementById('vermittlungsGebuehr').addEventListener('input', updateTrancheOneIfNeeded);
            document.getElementById('strukturierungsGebuehr').addEventListener('input', updateTrancheOneIfNeeded);

            // Initialisiere Tranche 1, wenn noch keine da ist
            if (document.querySelectorAll('.tranche').length === 0) {
                addTranche(true); // Füge die erste Tranche hinzu (ohne Remove-Button)
            }
            updateTrancheOne(); // Initialisiere die Werte der ersten Tranche
        });

        function updateTrancheOne() {
            const gesamtFinanzierung = parseFloat(document.getElementById('gesamtFinanzierung').value) || 1000000;
            const allInMezzanineZins = parseFloat(document.getElementById('allInMezzanineZins').value) || 15.0;
            const crowdZins = parseFloat(document.getElementById('crowdZins').value) || 7.0;
            const gesamtLaufzeit = parseInt(document.getElementById('gesamtLaufzeit').value) || 24;
            const vermittlungsGebuehr = parseFloat(document.getElementById('vermittlungsGebuehr').value) || 5.5;
            const strukturierungsGebuehr = parseFloat(document.getElementById('strukturierungsGebuehr').value) || 95000;

            const trancheFinInput = document.getElementById('trancheFinanzierung0');
            if (trancheFinInput) {
                 trancheFinInput.value = gesamtFinanzierung;
                 document.getElementById('trancheAllInMezzanineZins0').value = allInMezzanineZins;
                 document.getElementById('trancheCrowdZins0').value = crowdZins;
                 document.getElementById('laufzeit0').value = gesamtLaufzeit;
                 document.getElementById('trancheVermittlungsGebuehr0').value = vermittlungsGebuehr;
                 document.getElementById('trancheStrukturierungsGebuehr0').value = strukturierungsGebuehr;
            }
        }

        function updateTrancheOneIfNeeded() {
             const tranchenCount = document.querySelectorAll('.tranche').length;
             if (tranchenCount === 1) {
                 updateTrancheOne();
             }
         }

        function addTranche(isFirstTranche = false) {
            const tranchenContainer = document.getElementById('tranchenContainer');
            const tranchenCount = tranchenContainer.querySelectorAll('.tranche').length;

            if (!isFirstTranche && tranchenCount >= 3) {
                alert('Maximal 3 Tranchen möglich');
                return;
            }

            const trancheIndex = tranchenCount;

            // Nehme Werte aus globalen Feldern als Standard für neue Tranchen
            const defaultFinanzierung = parseFloat(document.getElementById('gesamtFinanzierung').value) || 1000000;
            const defaultAllIn = parseFloat(document.getElementById('allInMezzanineZins').value) || 15.0;
            const defaultCrowd = parseFloat(document.getElementById('crowdZins').value) || 7.0;
            const defaultLaufzeit = parseInt(document.getElementById('gesamtLaufzeit').value) || 24;
            const defaultVermittlung = parseFloat(document.getElementById('vermittlungsGebuehr').value) || 5.5;
            const defaultStrukturierung = parseFloat(document.getElementById('strukturierungsGebuehr').value) || 95000;


            const neueTrancheHTML = `
                <div class="calculator tranche" data-index="${trancheIndex}">
                    <div class="tranche-header">
                        <h2>Tranche ${trancheIndex + 1}</h2>
                        ${isFirstTranche ? '' : '<button class="btn-danger" onclick="removeTranche(this)">Entfernen</button>'}
                    </div>

                    <div class="form-group">
                        <label for="laufzeit${trancheIndex}">Laufzeit (Monate)</label>
                        <input type="number" id="laufzeit${trancheIndex}" class="laufzeit" value="${defaultLaufzeit}" min="1">
                    </div>
                    <div class="form-group">
                        <label for="trancheFinanzierung${trancheIndex}">Finanzierungssumme (€)</label>
                        <input type="number" id="trancheFinanzierung${trancheIndex}" class="trancheFinanzierung" value="${defaultFinanzierung}">
                    </div>
                    <div class="form-group">
                        <label for="trancheAllInMezzanineZins${trancheIndex}">All-in Mezzanine Zins (%)</label>
                        <input type="number" id="trancheAllInMezzanineZins${trancheIndex}" class="trancheAllInMezzanineZins" value="${defaultAllIn}" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="trancheCrowdZins${trancheIndex}">Crowd Zins (%)</label>
                        <input type="number" id="trancheCrowdZins${trancheIndex}" class="trancheCrowdZins" value="${defaultCrowd}" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="trancheVermittlungsGebuehr${trancheIndex}">Vermittlungsgebühr (%)</label>
                        <input type="number" id="trancheVermittlungsGebuehr${trancheIndex}" class="trancheVermittlungsGebuehr" value="${defaultVermittlung}" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="trancheStrukturierungsGebuehr${trancheIndex}">Strukturierungsgebühr (€)</label>
                        <input type="number" id="trancheStrukturierungsGebuehr${trancheIndex}" class="trancheStrukturierungsGebuehr" value="${defaultStrukturierung}">
                    </div>
                </div>
            `;
            tranchenContainer.insertAdjacentHTML('beforeend', neueTrancheHTML);

            if (tranchenContainer.querySelectorAll('.tranche').length >= 3) {
                document.getElementById('addTrancheBtn').disabled = true;
            }
        }

        function removeTranche(buttonElement) {
            const trancheToRemove = buttonElement.closest('.tranche');
            if (!trancheToRemove) return;

            const tranchenContainer = document.getElementById('tranchenContainer');
            trancheToRemove.remove();

            // Neu nummerieren
            const remainingTranchen = tranchenContainer.querySelectorAll('.tranche');
            remainingTranchen.forEach((tranche, newIndex) => {
                tranche.dataset.index = newIndex;
                tranche.querySelector('h2').textContent = `Tranche ${newIndex + 1}`;
                const inputs = tranche.querySelectorAll('input[type="number"]');
                const labels = tranche.querySelectorAll('label');

                labels.forEach(label => {
                    const oldFor = label.getAttribute('for');
                    if (oldFor) {
                        const baseName = oldFor.replace(/\d+$/, '');
                        label.setAttribute('for', `${baseName}${newIndex}`);
                    }
                 });
                 inputs.forEach(input => {
                     const oldId = input.id;
                     if (oldId) {
                         const baseName = oldId.replace(/\d+$/, '');
                         input.id = `${baseName}${newIndex}`;
                     }
                 });
            });

            document.getElementById('addTrancheBtn').disabled = false;
            updateTrancheOneIfNeeded();
        }

        function formatCurrency(value) {
            return new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR' }).format(value);
        }
        function formatPercent(value) {
            return new Intl.NumberFormat('de-DE', { style: 'percent', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(value / 100);
        }
        function formatQuartal(monat) {
            if (monat === 0) return "Initial";
            const jahr = Math.floor((monat - 1) / 12) + 1;
            const monatImJahr = ((monat - 1) % 12) + 1;
            const quartal = Math.ceil(monatImJahr / 3);
            return `J${jahr} Q${quartal}`;
        }


        // *** KORRIGIERTE BERECHNUNGSFUNKTION ***
        function calculateResults() {
            const vermittlungEndfaellig = document.getElementById('vermittlungEndfaellig').checked;
            const strukturierungEndfaellig = document.getElementById('strukturierungEndfaellig').checked;
            const tranchenElemente = document.querySelectorAll('.tranche');
            const tranchenErgebnisse = [];
            let errorOccurred = false; // Wird true bei Fehlern ODER Warnungen
            let errorMessages = [];

            // Reset
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('errorMessage').innerHTML = '';
            document.getElementById('trancheResults').innerHTML = '';
            document.getElementById('gesamtResults').style.display = 'none';
            document.getElementById('chartSection').style.display = 'none'; // Charts ausblenden

             // Alte Charts zerstören, falls vorhanden
            if (window.myDistributionChart) window.myDistributionChart.destroy();
            if (window.myBreakdownChart) window.myBreakdownChart.destroy();


            // --- Berechnung pro Tranche ---
            tranchenElemente.forEach((trancheElement, index) => {
                // Werte für DIESE Tranche auslesen
                const laufzeitMonate = parseInt(document.getElementById(`laufzeit${index}`).value) || 0;
                const laufzeitJahre = laufzeitMonate > 0 ? laufzeitMonate / 12 : 0;
                const gesamtFinanzierung = parseFloat(document.getElementById(`trancheFinanzierung${index}`).value) || 0;

                // Zinssätze und Gebühren für DIESE Tranche
                const allInMezzanineZins = parseFloat(document.getElementById(`trancheAllInMezzanineZins${index}`).value) || 0;
                const crowdZins = parseFloat(document.getElementById(`trancheCrowdZins${index}`).value) || 0;
                const trancheVermittlungsGebuehrProzent = parseFloat(document.getElementById(`trancheVermittlungsGebuehr${index}`).value) || 0;
                const trancheStrukturierungsGebuehrBetrag = parseFloat(document.getElementById(`trancheStrukturierungsGebuehr${index}`).value) || 0;

                // Validierung der Grund-Eingaben für diese Tranche
                if (laufzeitMonate <= 0 || gesamtFinanzierung <= 0) {
                    errorMessages.push(`Tranche ${index + 1}: Ungültige Laufzeit oder Finanzierungssumme.`);
                    errorOccurred = true; // Dies ist ein "fataler" Fehler für diese Tranche
                    return; // Nächste Tranche prüfen
                }

                // --- Kostenkomponenten berechnen ---
                const vermittlungsGebuehrBetrag = (trancheVermittlungsGebuehrProzent / 100) * gesamtFinanzierung;
                const strukturierungsGebuehrBetrag = trancheStrukturierungsGebuehrBetrag; // Ist bereits Betrag

                // Jährliche Zinsbeträge
                const crowdZinsenJahr = (crowdZins / 100) * gesamtFinanzierung;
                const allInMezzanineZinsenJahr = (allInMezzanineZins / 100) * gesamtFinanzierung;

                // Einmalige Gebühren auf Jahresbasis umrechnen
                const einmaligeGebuehrenProJahr = laufzeitJahre > 0 ? (vermittlungsGebuehrBetrag + strukturierungsGebuehrBetrag) / laufzeitJahre : 0;

                 // *** NEUE LOGIK FÜR SERVICEGEBÜHR ***
                // 1. Rohe Servicegebühr als Residualgröße berechnen
                const roheServiceGebuehrJahr = allInMezzanineZinsenJahr - crowdZinsenJahr - einmaligeGebuehrenProJahr;

                // 2. Effektive Servicegebühr initialisieren (kann später auf 0 gesetzt werden)
                let effektiveServiceGebuehrJahr = roheServiceGebuehrJahr;

                // 3. Prüfen, ob Servicegebühr negativ ist und Warnung ausgeben
                if (roheServiceGebuehrJahr < -0.001) { // Kleine Toleranz für Rundungsfehler
                    const negativerBetrag = Math.abs(roheServiceGebuehrJahr); // Der Betrag, um den es negativ ist

                    // Detaillierte Warnmeldung hinzufügen
                    errorMessages.push(
                        `Tranche ${index + 1}: Warnung! Die rechnerische Servicegebühr ist negativ (${formatCurrency(-negativerBetrag)} p.a.). ` +
                        `Dies bedeutet, die Summe aus Crowd-Zins und annualisierten Einmalgebühren (${formatCurrency(crowdZinsenJahr + einmaligeGebuehrenProJahr)} p.a.) ` +
                        `übersteigt den All-in Mezzanine Zins (${formatCurrency(allInMezzanineZinsenJahr)} p.a.). ` +
                        `Die Berechnung wird mit einer Servicegebühr von 0 fortgesetzt.`
                    );

                    // errorOccurred auf true setzen, damit die Meldung angezeigt wird.
                    // Die Berechnung läuft aber normal weiter (mit Servicegebühr 0).
                    errorOccurred = true; // Wird auch bei Warnungen gesetzt

                    // Effektive Servicegebühr für die weitere Berechnung auf 0 setzen
                    effektiveServiceGebuehrJahr = 0;
                }
                 // *** ENDE NEUE LOGIK FÜR SERVICEGEBÜHR ***


                // --- Zahlplan erstellen (mit effektiverServiceGebuehrJahr) ---
                const zahlplan = [];
                const anfangsVermittlung = !vermittlungEndfaellig ? vermittlungsGebuehrBetrag : 0;
                const anfangsStrukturierung = !strukturierungEndfaellig ? strukturierungsGebuehrBetrag : 0;
                if (anfangsVermittlung > 0 || anfangsStrukturierung > 0) {
                     zahlplan.push({ zeitpunkt: 0, vermittlungsGebuehr: anfangsVermittlung, vermittlungsGebuehrMwSt: anfangsVermittlung * 0.19, strukturierungsGebuehr: anfangsStrukturierung, strukturierungsGebuehrMwSt: anfangsStrukturierung * 0.19, crowdZins: 0, serviceGebuehr: 0, serviceGebuehrMwSt: 0 });
                }

                 if (laufzeitMonate > 0) {
                    // Quartalsweise Zahlungen - Servicegebühr korrekt verwenden
                    const serviceGebuehrQuartal = effektiveServiceGebuehrJahr / 4;
                    const serviceGebuehrMwStQuartal = serviceGebuehrQuartal * 0.19;
                    const crowdZinsQuartal = crowdZinsenJahr / 4;

                    for (let monat = 3; monat <= laufzeitMonate; monat += 3) {
                         zahlplan.push({
                             zeitpunkt: monat,
                             vermittlungsGebuehr: 0,
                             vermittlungsGebuehrMwSt: 0,
                             strukturierungsGebuehr: 0,
                             strukturierungsGebuehrMwSt: 0,
                             crowdZins: crowdZinsQuartal,
                             serviceGebuehr: serviceGebuehrQuartal, // Korrekt: Effektive (ggf. 0)
                             serviceGebuehrMwSt: serviceGebuehrMwStQuartal // Korrekt: Effektive (ggf. 0)
                         });
                    }
                 }

                 const endVermittlung = vermittlungEndfaellig ? vermittlungsGebuehrBetrag : 0;
                 const endStrukturierung = strukturierungEndfaellig ? strukturierungsGebuehrBetrag : 0;
                 if ((endVermittlung > 0 || endStrukturierung > 0) && laufzeitMonate > 0) {
                    const endfaelligkeitsZeitpunkt = laufzeitMonate;
                    const existingEntryIndex = zahlplan.findIndex(entry => entry.zeitpunkt === endfaelligkeitsZeitpunkt);
                    if (existingEntryIndex !== -1) {
                        zahlplan[existingEntryIndex].vermittlungsGebuehr += endVermittlung;
                        zahlplan[existingEntryIndex].vermittlungsGebuehrMwSt += endVermittlung * 0.19;
                        zahlplan[existingEntryIndex].strukturierungsGebuehr += endStrukturierung;
                        zahlplan[existingEntryIndex].strukturierungsGebuehrMwSt += endStrukturierung * 0.19;
                    } else {
                        zahlplan.push({ zeitpunkt: endfaelligkeitsZeitpunkt, vermittlungsGebuehr: endVermittlung, vermittlungsGebuehrMwSt: endVermittlung * 0.19, strukturierungsGebuehr: endStrukturierung, strukturierungsGebuehrMwSt: endStrukturierung * 0.19, crowdZins: 0, serviceGebuehr: 0, serviceGebuehrMwSt: 0 });
                    }
                }
                zahlplan.sort((a, b) => a.zeitpunkt - b.zeitpunkt);


                // --- Gesamtbeträge für die Tranche berechnen (nutzt Zahlplan, der die effektive Gebühr enthält) ---
                const gesamtVermittlungsGebuehr = zahlplan.reduce((sum, z) => sum + z.vermittlungsGebuehr, 0);
                const gesamtStrukturierungsGebuehr = zahlplan.reduce((sum, z) => sum + z.strukturierungsGebuehr, 0);
                const gesamtCrowdZinsen = zahlplan.reduce((sum, z) => sum + z.crowdZins, 0);
                const gesamtServiceGebuehr = zahlplan.reduce((sum, z) => sum + z.serviceGebuehr, 0); // Ist jetzt die Summe der effektiven (ggf. 0) Gebühren
                const gesamtVermittlungsGebuehrMwSt = zahlplan.reduce((sum, z) => sum + z.vermittlungsGebuehrMwSt, 0);
                const gesamtStrukturierungsGebuehrMwSt = zahlplan.reduce((sum, z) => sum + z.strukturierungsGebuehrMwSt, 0);
                const gesamtServiceGebuehrMwSt = zahlplan.reduce((sum, z) => sum + z.serviceGebuehrMwSt, 0); // Summe der MwSt auf die effektive Gebühr

                const gesamtKostenNetto = gesamtVermittlungsGebuehr + gesamtStrukturierungsGebuehr + gesamtCrowdZinsen + gesamtServiceGebuehr; // Korrekt mit ggf. 0 Servicegebühr
                const gesamtKostenBrutto = gesamtKostenNetto + gesamtVermittlungsGebuehrMwSt + gesamtStrukturierungsGebuehrMwSt + gesamtServiceGebuehrMwSt; // Korrekt

                const perAnnumNetto = laufzeitJahre > 0 ? gesamtKostenNetto / laufzeitJahre : 0;

                // Ergebnis speichern (speichert die effektiveServiceGebuehrJahr)
                 tranchenErgebnisse.push({
                    index: index, laufzeitMonate: laufzeitMonate, laufzeitJahre: laufzeitJahre, gesamtFinanzierung: gesamtFinanzierung,
                    allInMezzanineZins: allInMezzanineZins, crowdZins: crowdZins, trancheVermittlungsGebuehrProzent: trancheVermittlungsGebuehrProzent,
                    vermittlungsGebuehrBetrag: vermittlungsGebuehrBetrag, strukturierungsGebuehrBetrag: strukturierungsGebuehrBetrag,
                    serviceGebuehrJahr: effektiveServiceGebuehrJahr, // Hier die effektive Gebühr speichern
                    zahlplan: zahlplan, perAnnumNetto: perAnnumNetto,
                    gesamtKostenNetto: gesamtKostenNetto, gesamtKostenBrutto: gesamtKostenBrutto,
                    gesamtCrowdZinsen: gesamtCrowdZinsen, gesamtVermittlungsGebuehr: gesamtVermittlungsGebuehr,
                    gesamtStrukturierungsGebuehr: gesamtStrukturierungsGebuehr, gesamtServiceGebuehr: gesamtServiceGebuehr, // Summe der Zahlungen (effektiv)
                    gesamtVermittlungsGebuehrMwSt: gesamtVermittlungsGebuehrMwSt, gesamtStrukturierungsGebuehrMwSt: gesamtStrukturierungsGebuehrMwSt,
                    gesamtServiceGebuehrMwSt: gesamtServiceGebuehrMwSt // Summe der Zahlungen (effektiv)
                });

                // --- HTML für diese Tranche erstellen (zeigt effektiveServiceGebuehrJahr an) ---
                const strukturierungsGebuehrProzentTotal = gesamtFinanzierung > 0 ? (strukturierungsGebuehrBetrag / gesamtFinanzierung * 100) : 0;
                const serviceGebuehrProzentPA = gesamtFinanzierung > 0 ? (effektiveServiceGebuehrJahr / gesamtFinanzierung * 100) : 0;
                const summeProzentPA = gesamtFinanzierung > 0 ? (perAnnumNetto / gesamtFinanzierung * 100) : 0;

                const trancheHTML = `
                    <div class="results mb-4">
                        <h2>Tranche ${index + 1} - Laufzeit: ${laufzeitMonate} Monate (${laufzeitJahre.toFixed(1)} Jahre)</h2>
                        <table>
                           <thead>
                                <tr>
                                    <th>Komponente</th> <th>% p.a. / % Einmal</th> <th>Per Annum (€)</th> <th>Gesamt Netto (€)</th> <th>Gesamt Brutto (€)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr> <td class="font-medium">Finanzierungssumme</td> <td>-</td> <td>-</td> <td>${formatCurrency(gesamtFinanzierung)}</td> <td>-</td> </tr>
                                <tr> <td>All-in Mezzanine Zins</td> <td>${allInMezzanineZins.toFixed(2)} % p.a.</td> <td>${formatCurrency(allInMezzanineZinsenJahr)}</td> <td>${formatCurrency(allInMezzanineZinsenJahr * laufzeitJahre)}</td> <td>-</td> </tr>
                                <tr> <td>Crowd Zins</td> <td>${crowdZins.toFixed(2)} % p.a.</td> <td>${formatCurrency(crowdZinsenJahr)}</td> <td>${formatCurrency(gesamtCrowdZinsen)}</td> <td>${formatCurrency(gesamtCrowdZinsen)}</td> </tr>
                                <tr> <td>Vermittlungsgebühr</td> <td>${trancheVermittlungsGebuehrProzent.toFixed(2)} %</td> <td>${formatCurrency(laufzeitJahre > 0 ? gesamtVermittlungsGebuehr / laufzeitJahre : 0)}</td> <td>${formatCurrency(gesamtVermittlungsGebuehr)}</td> <td>${formatCurrency(gesamtVermittlungsGebuehr + gesamtVermittlungsGebuehrMwSt)}</td> </tr>
                                <tr> <td>Strukturierungsgebühr</td> <td>${strukturierungsGebuehrProzentTotal.toFixed(2)} %</td> <td>${formatCurrency(laufzeitJahre > 0 ? gesamtStrukturierungsGebuehr / laufzeitJahre : 0)}</td> <td>${formatCurrency(gesamtStrukturierungsGebuehr)}</td> <td>${formatCurrency(gesamtStrukturierungsGebuehr + gesamtStrukturierungsGebuehrMwSt)}</td> </tr>
                                <tr>
                                    <td>Servicegebühr</td>
                                    <td>${serviceGebuehrProzentPA.toFixed(2)} % p.a.</td>
                                    <td>${formatCurrency(effektiveServiceGebuehrJahr)}</td>
                                    <td>${formatCurrency(gesamtServiceGebuehr)}</td>
                                    <td>${formatCurrency(gesamtServiceGebuehr + gesamtServiceGebuehrMwSt)}</td>
                                </tr>
                                <tr class="font-bold bg-gray-100"> <td>Summe Kosten</td> <td>${summeProzentPA.toFixed(2)} % p.a.</td> <td>${formatCurrency(perAnnumNetto)}</td> <td>${formatCurrency(gesamtKostenNetto)}</td> <td>${formatCurrency(gesamtKostenBrutto)}</td> </tr>
                            </tbody>
                        </table>
                         <h3 class="mt-4 mb-2">Zahlplan (Tranche ${index + 1})</h3>
                        <table>
                             <thead>
                                <tr> <th>Zeitpunkt</th> <th>Vermittlung (€)</th> <th>Strukturierung (€)</th> <th>Crowd Zinsen (€)</th> <th>Servicegebühr (€)</th> <th>Gesamt Netto (€)</th> <th>MwSt (€)</th> <th>Gesamt Brutto (€)</th> </tr>
                            </thead>
                           <tbody>
                                ${zahlplan.length === 0 ? '<tr><td colspan="8">Keine Zahlungen geplant.</td></tr>' :
                                zahlplan.map(zahlung => {
                                    const zeileNetto = zahlung.vermittlungsGebuehr + zahlung.strukturierungsGebuehr + zahlung.crowdZins + zahlung.serviceGebuehr;
                                    const zeileMwSt = zahlung.vermittlungsGebuehrMwSt + zahlung.strukturierungsGebuehrMwSt + zahlung.serviceGebuehrMwSt;
                                    const zeileBrutto = zeileNetto + zeileMwSt;
                                    return `<tr><td>${formatQuartal(zahlung.zeitpunkt)}</td> <td>${formatCurrency(zahlung.vermittlungsGebuehr)}</td> <td>${formatCurrency(zahlung.strukturierungsGebuehr)}</td> <td>${formatCurrency(zahlung.crowdZins)}</td> <td>${formatCurrency(zahlung.serviceGebuehr)}</td> <td>${formatCurrency(zeileNetto)}</td> <td>${formatCurrency(zeileMwSt)}</td> <td>${formatCurrency(zeileBrutto)}</td></tr>`;
                                }).join('')}
                                <tr class="font-bold bg-gray-100"> <td>Gesamt</td> <td>${formatCurrency(gesamtVermittlungsGebuehr)}</td> <td>${formatCurrency(gesamtStrukturierungsGebuehr)}</td> <td>${formatCurrency(gesamtCrowdZinsen)}</td> <td>${formatCurrency(gesamtServiceGebuehr)}</td> <td>${formatCurrency(gesamtKostenNetto)}</td> <td>${formatCurrency(gesamtVermittlungsGebuehrMwSt + gesamtStrukturierungsGebuehrMwSt + gesamtServiceGebuehrMwSt)}</td> <td>${formatCurrency(gesamtKostenBrutto)}</td> </tr>
                            </tbody>
                        </table>
                    </div>
                `;
                document.getElementById('trancheResults').insertAdjacentHTML('beforeend', trancheHTML);

            }); // Ende forEach Tranche


             // --- Fehler/Warnungen anzeigen ---
            if (errorOccurred) {
                document.getElementById('errorMessage').style.display = 'block';
                document.getElementById('errorMessage').innerHTML = errorMessages.join('<br>');
            }

            // --- Ergebnisse anzeigen (wenn mind. eine Tranche berechnet wurde) ---
            if (tranchenErgebnisse.length > 0) {
                document.getElementById('results').style.display = 'block';

                // --- Gesamtergebnis über alle Tranchen berechnen & anzeigen ---
                const gesamtFinanzierungAlle = tranchenErgebnisse.reduce((sum, t) => sum + t.gesamtFinanzierung, 0);
                const gesamtKostenNettoAlle = tranchenErgebnisse.reduce((sum, t) => sum + t.gesamtKostenNetto, 0);
                const gesamtKostenBruttoAlle = tranchenErgebnisse.reduce((sum, t) => sum + t.gesamtKostenBrutto, 0);
                const gesamtCrowdZinsenAlle = tranchenErgebnisse.reduce((sum, t) => sum + t.gesamtCrowdZinsen, 0);
                const gesamtVermittlungAlle = tranchenErgebnisse.reduce((sum, t) => sum + t.gesamtVermittlungsGebuehr, 0);
                const gesamtStrukturierungAlle = tranchenErgebnisse.reduce((sum, t) => sum + t.gesamtStrukturierungsGebuehr, 0);
                const gesamtServiceAlle = tranchenErgebnisse.reduce((sum, t) => sum + t.gesamtServiceGebuehr, 0);

                 let gewichteteLaufzeitSumme = 0;
                 tranchenErgebnisse.forEach(t => { gewichteteLaufzeitSumme += t.gesamtFinanzierung * t.laufzeitMonate; });
                 const gewichteteLaufzeitMonate = gesamtFinanzierungAlle > 0 ? gewichteteLaufzeitSumme / gesamtFinanzierungAlle : 0;
                 const gewichteteLaufzeitJahre = gewichteteLaufzeitMonate / 12;
                 const effektivZinsNettoPA = (gesamtFinanzierungAlle > 0 && gewichteteLaufzeitJahre > 0) ? (gesamtKostenNettoAlle / gesamtFinanzierungAlle / gewichteteLaufzeitJahre) * 100 : 0;

                 document.getElementById('gesamtFinanzierungSumme').textContent = formatCurrency(gesamtFinanzierungAlle);
                 document.getElementById('gesamtGewichteteLaufzeit').textContent = `${gewichteteLaufzeitMonate.toFixed(1)} Monate (${gewichteteLaufzeitJahre.toFixed(1)} Jahre)`;
                 document.getElementById('gesamtKostenNettoSumme').textContent = formatCurrency(gesamtKostenNettoAlle);
                 document.getElementById('gesamtCrowdZinsSumme').textContent = formatCurrency(gesamtCrowdZinsenAlle);
                 document.getElementById('gesamtVermittlungsGebuehrSumme').textContent = formatCurrency(gesamtVermittlungAlle);
                 document.getElementById('gesamtStrukturierungsGebuehrSumme').textContent = formatCurrency(gesamtStrukturierungAlle);
                 document.getElementById('gesamtServiceGebuehrSumme').textContent = formatCurrency(gesamtServiceAlle);
                 document.getElementById('gesamtKostenBruttoSumme').textContent = formatCurrency(gesamtKostenBruttoAlle);
                 document.getElementById('gesamtEffektivZinsNettoPA').textContent = `${effektivZinsNettoPA.toFixed(2)} %`;

                 document.getElementById('gesamtResults').style.display = 'block';

                // --- Diagramme erstellen ---
                 let hasFatalError = false; // Prüfen, ob Tranchen wegen Validierungsfehler übersprungen wurden
                 tranchenElemente.forEach((el, idx) => {
                     if (!tranchenErgebnisse.find(t => t.index === idx)) {
                        hasFatalError = true;
                     }
                 });

                 if (!hasFatalError) { // Nur Charts anzeigen, wenn keine Tranche komplett fehlgeschlagen ist
                     createCharts(tranchenErgebnisse, gesamtKostenNettoAlle, gesamtCrowdZinsenAlle, gesamtVermittlungAlle, gesamtStrukturierungAlle, gesamtServiceAlle);
                     document.getElementById('chartSection').style.display = 'block';
                 } else {
                    document.getElementById('chartSection').style.display = 'none';
                 }

             } else {
                 document.getElementById('results').style.display = 'none';
             }
        } // Ende calculateResults


        // --- Funktion zum Erstellen der Diagramme (unverändert) ---
        function createCharts(tranchenErgebnisse, gesamtKostenNettoAlle, gesamtCrowdZinsenAlle, gesamtVermittlungAlle, gesamtStrukturierungAlle, gesamtServiceAlle) {

            // --- 1. Liniendiagramm: Kostenverteilung über Zeit (Netto) ---
            const aggregatedPayments = {}; // { zeitpunkt: totalNetCost }
            let maxZeitpunkt = 0;

            tranchenErgebnisse.forEach(tranche => {
                tranche.zahlplan.forEach(zahlung => {
                    const zeitpunkt = zahlung.zeitpunkt;
                    const nettoKosten = zahlung.vermittlungsGebuehr + zahlung.strukturierungsGebuehr + zahlung.crowdZins + zahlung.serviceGebuehr;
                    if (nettoKosten > 0) {
                        aggregatedPayments[zeitpunkt] = (aggregatedPayments[zeitpunkt] || 0) + nettoKosten;
                        maxZeitpunkt = Math.max(maxZeitpunkt, zeitpunkt);
                    }
                });
            });

            const distributionLabels = [];
            const distributionData = [];
            const allZeitpunkte = Object.keys(aggregatedPayments).map(Number).sort((a, b) => a - b);

            allZeitpunkte.forEach(zp => {
                distributionLabels.push(formatQuartal(zp));
                distributionData.push(aggregatedPayments[zp]);
            });


            const ctxDist = document.getElementById('costDistributionChart').getContext('2d');
            window.myDistributionChart = new Chart(ctxDist, { /* ... Chart config wie vorher ... */
                 type: 'line',
                data: {
                    labels: distributionLabels,
                    datasets: [{
                        label: 'Netto-Gesamtkosten pro Zeitpunkt',
                        data: distributionData,
                        borderColor: 'rgb(54, 162, 235)',
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        tension: 0.1,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { callback: function(value) { return formatCurrency(value); } }
                        }
                    },
                     plugins: { tooltip: { callbacks: { label: function(context) { return (context.dataset.label || '') + ': ' + formatCurrency(context.parsed.y); } } } }
                }
            });


             // --- 2. Kreisdiagramm: Aufteilung Gesamtkosten (Netto) ---
            const breakdownLabels = ['Crowd-Zinsen', 'Vermittlungsgebühr', 'Strukturierungsgebühr', 'Servicegebühr'];
            const breakdownData = [ gesamtCrowdZinsenAlle, gesamtVermittlungAlle, gesamtStrukturierungAlle, gesamtServiceAlle ];
            const filteredLabels = [];
            const filteredData = [];
            breakdownData.forEach((value, index) => { if (value > 0.001) { filteredLabels.push(breakdownLabels[index]); filteredData.push(value); } });


            const ctxBreakdown = document.getElementById('costBreakdownChart').getContext('2d');
            window.myBreakdownChart = new Chart(ctxBreakdown, { /* ... Chart config wie vorher ... */
                type: 'doughnut',
                data: {
                    labels: filteredLabels,
                    datasets: [{
                        label: 'Netto-Gesamtkosten Aufteilung',
                        data: filteredData,
                        backgroundColor: [ 'rgb(255, 99, 132)', 'rgb(54, 162, 235)', 'rgb(255, 205, 86)', 'rgb(75, 192, 192)' ],
                        hoverOffset: 4
                    }]
                },
                 options: {
                    responsive: true, maintainAspectRatio: true,
                     plugins: {
                        tooltip: { callbacks: { label: function(context) { let label = context.label || ''; let value = context.parsed || 0; let sum = context.dataset.data.reduce((a, b) => a + b, 0); let percentage = sum > 0 ? ((value / sum) * 100).toFixed(1) + '%' : '0.0%'; return `${label}: ${formatCurrency(value)} (${percentage})`; } } },
                        legend: { position: 'top' }
                    }
                }
            });
        } // Ende createCharts

    </script>
</body>
</html>
